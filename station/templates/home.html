{% extends "base.html" %}

{% block content %}
<meta name="microtip" content="Audio">
<meta name="microtip" content="1BoYSGVTHL9ERrFgSk9wDu9GsRUKABdTRc" data-recipient="Bandwidth Fund">
<style>
    h1 {
        text-align: center;
    }
    .title, .artist {
        font-size: large;
        font-weight: bold
    }

    .error {
        color: red;
        font-size: x-large;
    }

    #currently_playing {
        margin: 0 auto;
        text-align: center;
        padding: 10px;
        border: 1px solid black;
        background: #dfdfdf;
        max-width: 400px;
        min-height: 350px;
    }

    #currently_playing img {
        height: 300px;
    }

    .center {
        padding: 10px;
        width: 500px;
        background: #f2f2f2;
        border: 1px solid gray;
        font-family: verdana;
        margin: 0 auto;
    }

    .buttons {
        text-align: center;
    }

    .buttons button {
        margin: 10px;
        font-size: large;
    }

</style>
<div class="center">
    <h1>{{ TITLE|default:"The Station"|safe }}</h1>

    <div class="buttons">
        <button id="mute">Mute</button><button id="unmute" style="display: none">Un-mute</button>
        <button id="start2" style="display: none" onclick="window.location = '/play'">Restart</button>
        <button id="start">Start</button>
        <button id="stop" style="display: none">Stop</button>
    </div>
    <br>

    Next Song:
    <div id="next_song"></div>
    <br>
    <div id="currently_playing"></div>

    <audio id="player"></audio>

    <div id="player_container">
    </div>

    <br>
    <br>
    Play history:
    <div id="last_played_container"></div>
</div>

<script type="text/javascript" src="{{ STATIC_URL }}admin/js/jquery.js"></script>

<script>
    var all_voices = window.speechSynthesis.getVoices();
    function make_bumper(words) {
        $('#player').animate({volume: 0.1}, 500);
        var msg = new SpeechSynthesisUtterance(words);
        var this_hour = (new Date()).getHours();
        msg.voice = all_voices[this_hour];
        msg.onend = function() {
            // after speech is over, bring volume back
            $('#player').animate({volume: 1.0}, 500);
        }
        window.speechSynthesis.speak(msg);
    }

    function get_info_from_lastfm(artist_name, track_name) {
        var artist = $
        var key = "{{ LASTFM_KEY }}";

        if(key == '') {
            // No lastfm API key configured on the backend.
            return
        }

        var url = "http://ws.audioscrobbler.com/2.0/?method=track.getInfo&api_key=" + key +
        "&artist=" + artist_name + "&track=" + track_name + "&format=json";

        $.ajax({
            url: url,
            success: function(response) {
                console.log(response);
                if(response.error) {
                    console.log("Last fm returned error:", response.message);
                    return
                }
                var img = response.track.album.image[3]; // large size
                $("#currently_playing img").attr('src', img["#text"]);
            }
        })
    }

    $('#player').on('timeupdate', function() {
        // update the seek bar as the song plays.
        $('#seekbar').attr("value", this.currentTime / this.duration);
    }).on('ended', function() {
        // when a song ends, add it to the play history section.
        // there is a one second gap between the last song ending
        // and the next song starting. During that gap, the "current
        // song" is actualy the previous song.

        var artist = $("#currently_playing .artist").text();
        var title = $("#currently_playing .title").text();
        var year = $("#currently_playing .year").text();

        var new_row = $(
            "<div class='play_history'>" +
            artist + " - " + year + " - " + title +
            "</div>"

        );
        $("#last_played_container").prepend(new_row);
    });

    $("#mute").click(function() {
        $(this).hide();
        $('#player').get(0).volume = 0.01;
        $("#unmute").show();
    });

    $("#unmute").click(function() {
        $(this).hide();
        $('#player').get(0).volume = 1.0;
        $("#mute").show();
    })

    var stream_enabled = false;
    $("#stop").click(function() {
        $("#player").get(0).pause();
        stream_enabled = false;
        $("#start2").show();
        $(this).hide();
    });
    $("#start").click(function() {
        // get the streaming process going.
        stream_enabled = true;
        fetch_next_track();
        $("#stop").show();
        $(this).hide();
    });

    function switch_currently_playing(new_song, skip_ahead) {
        if(!stream_enabled) {
            return
        }
        var player = $("#player");
        player.attr('src', new_song.url);

        player.text(JSON.stringify(new_song.tips));

        if(skip_ahead) {
            console.log("skipping ahead", skip_ahead);
            //player.get(0).currentTime = skip_ahead;
        } else {
            $("#next_song").html("&nbsp;");
        }

        get_info_from_lastfm(new_song.artist, new_song.title);

        $("#currently_playing").html(
            "Currently Playing<br><br>" +
            "<img><br>" +
            "<span class='artist'>" + new_song.artist + "</span> - "
            + "[<span class='year'>" + new_song.year + "</span>] "
            + "<span class='title'>" + new_song.title + "</span>" +
            "<progress id='seekbar' value='0' max='1' style='width:400px;'></progress>"
        );
        player.get(0).play();
    }

    function fetch_next_track() {
        // hit the backend to get the next song.
        $.ajax({
            url: "/current_and_next_song",
            type: "get",
            complete: function(response) {
                console.log("fetching next song");
                response = response.responseJSON;
                next_song = response.next_song
                current_song = response.current_song

                $("#next_song").html("<span class='artist'>" + next_song.artist + "</span> - <span class='title'>" + next_song.title + "</span>");

                // anywhere between 25% and 75% of the play time.
                seconds_to_fetch_next = next_song.duration * (Math.random() * 0.5 + 0.25);
                console.log("after current song ends, wait " + seconds_to_fetch_next + " seconds until next fetch");

                if(!$("#player").attr('src')) {
                    // streaming first started
                    var seconds_skip_ahead = ((new Date()).getTime() - (new Date(current_song.start_time))) / 1000;
                    switch_currently_playing(current_song, seconds_skip_ahead);

                    // when to change to the next track
                    var next_start_date = new Date(next_song.start_time);
                    var switch_track_miliseconds = next_start_date.getTime() - (new Date()).getTime();

                    console.log("switching to next track in " + switch_track_miliseconds / 1000 + "seconds");
                    setTimeout(function() {
                        switch_currently_playing(next_song)
                    }, switch_track_miliseconds);

                    var next_fetch_miliseconds = switch_track_miliseconds + (seconds_to_fetch_next * 1000);
                    setTimeout(fetch_next_track, next_fetch_miliseconds);
                    console.log("First invocation! will fetch next song in " + next_fetch_miliseconds / 1000 + " seconds");
                    return
                }

                // when this track is supposed to start
                var play_date = new Date(next_song.start_time);

                var miliseconds_from_now = play_date.getTime() - (new Date()).getTime();

                // schedule the next track change.
                setTimeout(function() {
                    switch_currently_playing(next_song)
                }, miliseconds_from_now);

                // schedule the next song fetch
                if(stream_enabled) {
                    setTimeout(fetch_next_track, seconds_to_fetch_next * 1000);
                    console.log("next song is " + next_song.duration + " seconds long");
                    console.log("will fetch next song in " + seconds_to_fetch_next + " seconds");
                }
            },
            error: function() {
                $("#next_song").html("<span class='error'>Could not fetch next song. Try restarting the station.</span>")
                $("#stop").click();
            }
        });
    }

    {% if autoplay %}
    // Automatically start the station because '/play' in url.
    $("#start").click();
    {% endif%}
</script>

{% endblock %}
