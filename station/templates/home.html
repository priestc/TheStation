{% extends "base.html" %}

{% block content %}
<meta name="microtip" content="Audio">
<meta name="microtip" content="1BoYSGVTHL9ERrFgSk9wDu9GsRUKABdTRc" data-recipient="Bandwidth Fund">
<link type="text/css" rel="stylesheet" href="{{ STATIC_URL }}station.css">

<div class="center">
    <h1>{{ TITLE|default:"The Station"|safe }}</h1>

    <div class="buttons">
        <button id="mute" style="display: none">Mute</button><button id="unmute" style="display: none">Un-mute</button>
        <button id="start2" style="display: none" onclick="window.location = '/play'">Restart</button>
        <button id="start">Start Listening</button>
        <button id="stop" style="display: none">Stop</button>
    </div>
    <br>

    Next Song:
    <div id="next_song"></div>
    <br>
    <br>
    <div id="currently_playing" class="grayed">
        {% comment %}
        Currently Playing<br><br>
        <audio src='{{ current_play.url }}' preload="none">
            {{ current_song.tips }}
        </audio>
        <img src='{{ current_play.img }}'><br>
        <span class='artist'>{{ current_play.artist }}</span> -
        [<span class='year'>{{ current_play.year }}</span>]
        <span class='title'>{{ current_play.title }}</span>
        <span class='start_time'>{{ current_play.start_time }}</span>
        <progress value='0' max='1' style='width: 80%'></progress>
        {% endcomment %}
    </div>
    <div id="currently_playing_cache" style="display: none"></div>
    <br>
    <br>
    <div id="last_played_header" style="display:none">Play History:</div>
    <div id="last_played_container"></div>
    <small>Powered by <a href="http://github.com/priestc/TheStation">TheStation</a></small>
</div>

<script type="text/javascript" src="{{ STATIC_URL }}admin/js/jquery.js"></script>

<script>
    var enable_skip_ahead = {{ SKIP_AHEAD|lower }};

    var all_voices = window.speechSynthesis.getVoices();
    function make_bumper(words) {
        $('#currently_playing audio').animate({volume: 0.1}, 500);
        var msg = new SpeechSynthesisUtterance(words);
        var this_hour = (new Date()).getHours();
        msg.voice = all_voices[this_hour];
        msg.onend = function() {
            // after speech is over, bring volume back
            $('#currently_playing audio').animate({volume: 1.0}, 500);
        }
        window.speechSynthesis.speak(msg);
    }

    function miliseconds_from_now(some_date) {
        // passed in must be an instance of Date.
        return some_date.getTime() - (new Date()).getTime();
    }

    $("#mute").click(function() {
        $(this).hide();
        $('#currently_playing audio').get(0).volume = 0.01;
        $("#unmute").show();
    });

    $("#unmute").click(function() {
        $(this).hide();
        $('#currently_playing audio').get(0).volume = 1.0;
        $("#mute").show();
    });

    var stream_enabled = false;
    $("#stop").click(function() {
        $('#currently_playing audio').get(0).pause();
        stream_enabled = false;
        $("#start2").show();
        $(this).hide();
        $("#currently_playing").addClass("grayed");
    });
    $("#start").click(function(event, autostart) {
        // get the streaming process going.
        console.log("start button clicked!!!!");
        stream_enabled = true;
        if(!autostart) {
            // don't call this function when doing autostart,
            // because of a race condition.
            start_playing_song();
        }
        $("#stop").show();
        $("#mute").show();
        $(this).hide();
        $("#currently_playing").removeClass("grayed");
    });

    function start_playing_song() {
        // This function is called at the time of the next song starting
        // either at the begining of the song, or while it is in progress.

        if(stream_enabled) {
            $("#currently_playing audio").get(0).play();
            $("#currently_playing audio").on('timeupdate', function() {
                // update the seek bar as the song plays.
                $('progress').attr("value", this.currentTime / this.duration);
            });

            $("#currently_playing audio").on('ended', function() {
                // when a song ends, add it to the play history section.
                // there is a one second gap between the last song ending
                // and the next song starting. During that gap, the "current
                // song" is actualy the previous song.

                var artist = $("#currently_playing .artist").text();
                var title = $("#currently_playing .title").text();
                var year = $("#currently_playing .year").text();

                var new_row = $(
                    "<div class='play_history'>" +
                    artist + " - " + year + " - " + title +
                    "</div>"
                );

                $("#last_played_header").show()
                $("#last_played_container").prepend(new_row);
            });
        } else {
            console.log("not playing sound because not started");
        }

        var start_time = new Date($("#currently_playing .start_time").text());

        console.log("start time of currently playing song", start_time);
        console.log("time is now", (new Date()));

        var seconds_in_prgress = -1 * miliseconds_from_now(start_time) / 1000;

        console.log($("#currently_playing .title").text(), "is", seconds_in_prgress, " seconds in progress")

        if(seconds_in_prgress > 10 && enable_skip_ahead) {
            // song was supposed to start more than 10 seconds ago. Skip ahead
            // to the correct time
            $('#currently_playing audio').bind('canplay', function() {
                this.currentTime = seconds_in_prgress;
            });
        }
    }

    function make_currently_playing(song, element) {
        // song = object that comes from next_song or current_song (API call)
        // element = the element we write this info to. can be either the
        // visible one or the hidden one (for cache).

        var preload = stream_enabled ? "auto" : "none";

        element.html("Currently Playing<br><br>" +
            "<audio class='autotip' src='" + song.url + "' preload='" + preload + "'>"
            + JSON.stringify(song.tips)
            + "</audio>"
            + "<img src='" + song.img + "'><br>"
            + "<span class='artist'>" + song.artist + "</span> - "
            + "[<span class='year'>" + song.year + "</span>] "
            + "<span class='title'>" + song.title + "</span>"
            + "<span class='start_time'>" + song.start_time + "</span>"
            + "<progress value='0' max='1' style='width: 80%'></progress>"
        );
    }

    function fetch_next_track() {
        // hit the backend to get the next song.
        $.ajax({
            url: "/current_and_next_song",
            type: "get",
            complete: function(response) {
                console.log("fetching next song");
                response = response.responseJSON;
                next_song = response.next_song;
                current_song = response.current_song;

                $("#next_song").html(
                    "<span class='artist'>" + next_song.artist + "</span>" +
                    " - <span class='title'>" + next_song.title + "</span>"
                );

                // load next track into the background so the image and mp3 preload
                // that way when its time to switch to the next track, it is instant.
                make_currently_playing(next_song, $("#currently_playing_cache"));

                if($("#currently_playing").text().trim() == '') {
                    // the station has just started up, fill in currently playing too.
                    make_currently_playing(current_song, $("#currently_playing"));
                    start_playing_song();
                }

                // schedule the next song switch event
                var next_start_date = new Date(next_song.start_time);
                var from_now_miliseconds = next_start_date.getTime() - (new Date()).getTime();
                console.log("setting play switch event of", next_song.title);
                setTimeout(function() {
                    console.log("executing play switch event for", next_song.title);
                    make_currently_playing(next_song, $("#currently_playing"));
                    $("#next_song").html("&nbsp");
                    start_playing_song();
                }, from_now_miliseconds);

                // schedule the next track fetch (every 20 seconds)
                setTimeout(fetch_next_track, 20000);
            },
            error: function() {
                $("#next_song").html("<span class='error'>Could not fetch next song. Try restarting the station.</span>")
                $("#stop").click();
            }
        });
    }
    fetch_next_track();

    {% if autoplay %}
    // Automatically start the station because '/play' in url.
    $("#start").trigger('click', ['autostart']);
    {% endif%}
</script>

{% endblock %}
